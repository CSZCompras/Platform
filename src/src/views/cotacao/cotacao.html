<template>
   <require from="jquery-datetimepicker/jquery.datetimepicker.min.css"></require>
   <require from="../components/attributes/datepicker"></require>
   <require from="../components/attributes/moneyMask"></require>
   <require from="../components/valueConverters/moneyValueConverter"></require>
   <require from="../components/valueConverters/dateFormatValueConverter"></require>
   <require from="../components/attributes/timeMask"></require>
   <require from="../components/valueConverters/timeValueConverter"></require>
   <div class="row mb-5 au-animate">
      <div class="col-md-12">
         <div class="card">
            <div class="card-header">
               Cotação
               <div class="progress">
                  <div class="progress-bar progress-bar-sm bg-gradient" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
               </div>
            </div>
            <div class="card-form-wizard">
               <div class="row">
                  <div class="col-lg-12">
                     <div id="rootwizard-1">
                        <ul class="nav nav-pills">
                           <li>
                              <a href="#tab1" data-toggle="tab">
                              <span class="main-text">
                              <span class="h3">1. Lista de Compras</span>
                              </span>
                              </a>
                           </li>
                           <li>
                              <a href="#tab2" data-toggle="tab">
                              <span class="main-text">
                              <span class="h3">2. Cotações</span>
                              </span>
                              </a>
                           </li>
                           <li>
                              <a href="#tab3" data-toggle="tab">
                              <span class="main-text">
                              <span class="h3">3. Pedido</span>
                              </span>
                              </a>
                           </li>
                        </ul>
                        <div class="tab-content clearfix">
                           <div class="tab-pane" id="tab1">
                              <div class="card-body">
                                 <div class="row">
                                    <div class="col-md-4">
                                       <div class="form-group">
                                          <h4 class="control-label">Selecione a lista de compras</h4>
                                          <select class="form-control " value.bind="selectedQuote" change.trigger="loadDeliveryRule()">
                                             <option value=""></option>
                                             <option repeat.for="quote of quotes" model.bind="quote">${quote.buyListName}</option>
                                          </select>
                                       </div>
                                    </div>
                                 </div>
                                 <div id="accordion" role="tablist" aria-multiselectable="true">
                                    <div class="tab-content clearfix ml-5" repeat.for="market of selectedQuote.markets">
                                       <div class="row mt-2">
                                          <h4>
                                             <a data-toggle="collapse" data-parent="#accordion" href="#collapse${market.id}" aria-expanded="false" aria-controls="collapse${market.id}" click.trigger="showHideMarket(market)">
                                                <i class="fa fa-tag mr-2"></i> ${market.name}
                                             </a>
                                          </h4>
                                       </div>
                                       <div id="collapse${market.id}" role="tabpanel" aria-labelledby="collapse${market.id}" class="row mt-2 collapse ${market.show ? '' :  'invisible' }">
                                          <div if.bind="market.items.length > 0">
                                             <div class="row mt-3">
                                                <div class="col-md-3">
                                                   <div class="form-group">
                                                      <label class="control-label">Informe a data de entrega</label>
                                                      <input type="text" class="form-control" autocomplete="off" placeholder="00/00/0000" value.bind="market.checkDeliveryViewModel.deliveryDate | dateFormat " datepicker change.trigger="checkDeliveryDate(market)">
                                                   </div>
                                                </div>
                                                <div class="col-md-3">
                                                   <div class="form-group">
                                                      <label class="control-label">Horário inicial</label>
                                                      <div class="input-group">
                                                         <span class="input-group-addon input-group-icon">
                                                         <i class="batch-icon batch-icon-clock"></i>
                                                         </span>
                                                         <input type="time" class="time form-control" autocomplete="off" placeholder="HH:mm" time value.bind="market.checkDeliveryViewModel.deliveryScheduleStart | time " change.trigger="checkDeliveryDate(market)" />
                                                      </div>
                                                   </div>
                                                </div>
                                                <div class="col-md-3">
                                                   <div class="form-group">
                                                      <label class="control-label">Horário final</label>
                                                      <div class="input-group">
                                                         <span class="input-group-addon input-group-icon">
                                                         <i class="batch-icon batch-icon-clock"></i>
                                                         </span>
                                                         <input type="time" class="time form-control" autocomplete="off" placeholder="HH:mm" time value.bind="market.checkDeliveryViewModel.deliveryScheduleEnd | time " change.trigger="checkDeliveryDate(market)" />
                                                      </div>
                                                   </div>
                                                </div>
                                             </div>
                                          </div>
                                       <div class="row">
                                          <div class="col-md-12  mt-5">
                                             <span class="badge badge-warning" if.bind="market.items.length == 0">Lista sem produtos selecionados. Favor incluir em Produtos > Meus Produtos </span>
                                             <div if.bind="market.items.length > 0 ">
                                                <div class="col-md-12 mt-1">
                                                   <div class="form-group">
                                                      <div class="row mt-3">
                                                         <p>
                                                            Alertas
                                                         </p>
                                                         <div class="col-md-12" repeat.for="x of market.checkDeliveryResult.items">
                                                            <span class="badge badge-danger">${x.message}</span>
                                                         </div>
                                                      </div>
                                                      <div class="row mt-5">
                                                         <p>Você pode remover fornecedores da sua cotação</p>
                                                      </div>
                                                      <div class="row mt-1">
                                                         <span style="padding : 10px; cursor: pointer;" click.trigger="addRemoveSupplier(market, supplier)" repeat.for="supplier of market.suppliers" class="badge ${ supplier.isInvalid ? 'badge-danger' : ! supplier.wasRemoved ?  'badge-success' : 'badge-default' }  ml-3 mt-2">                                                                    
                                                         <i class="fa fa-times mr-3" if.bind="supplier.isInvalid" aria-hidden="true" style="cursor: pointer;" click.trigger="removeSupplier(market, supplier)"></i>
                                                         <i class="fa fa-times mr-3" if.bind="! supplier.wasRemoved && ! supplier.isInvalid" aria-hidden="true" style="cursor: pointer;" click.trigger="removeSupplier(market, supplier)"></i>
                                                         <i class="fa fa-plus mr-3" if.bind="supplier.wasRemoved && ! supplier.isInvalid" aria-hidden="true" style="cursor: pointer;" click.trigger="addSupplier(market, supplier)"></i>
                                                         ${supplier.name}
                                                         </span>
                                                      </div>
                                                   </div>
                                                   <table class="table table-hover table-responsive mt-5">
                                                      <thead>
                                                         <tr>
                                                            <th>Nome do produto</th>
                                                            <th>Descrição</th>
                                                            <th>Categoria</th>
                                                            <th>UM</th>
                                                            <th>Marca</th>
                                                            <th class="text-center">Fornecedores</th>
                                                            <th class="text-center">Quantidade</th>
                                                         </tr>
                                                      </thead>
                                                      <tbody>
                                                         <tr repeat.for="product of market.items">
                                                            <td>
                                                               <span class="badge badge-warning" if.bind="product.suppliers == null || product.suppliers.length == 0">
                                                               <i class="fa fa-warning"></i> 
                                                               ${product.name}
                                                               </span>
                                                               <span if.bind="product.suppliers != null && product.suppliers.length > 0">${product.name}</span>
                                                            </td>
                                                            <td>${product.description}</td>
                                                            <td>${product.category}</td>
                                                            <td>${product.unitOfMeasure}</td>
                                                            <td>${product.brand}</td>
                                                            <td class="text-right">
                                                               <span style="padding : 10px; cursor: pointer;" click.trigger="addRemoveSupplier(market, supplier)" repeat.for="supplier of product.suppliers" class="badge ${  supplier.isInvalid ? 'badge-danger' : ! supplier.wasRemoved ?  'badge-success' : 'badge-default' }  ml-3 mt-2">
                                                               <i class="fa fa-times mr-3" if.bind="! supplier.wasRemoved && ! suplier.isInvalid " aria-hidden="true" style="cursor: pointer;" click.trigger="removeSupplier(market, supplier)"></i>
                                                               <i class="fa fa-plus mr-3" if.bind="supplier.wasRemoved && ! suplier.isInvalid  " aria-hidden="true" style="cursor: pointer;" click.trigger="addSupplier(market, supplier)"></i>
                                                               ${supplier.name}
                                                               </span>
                                                               <span class="font-bold" if.bind="product.suppliers == null || product.suppliers.length == 0">Não há fornecedores cadastrados que oferecem esse produto</span>
                                                            </td>
                                                            <td class="text-center">
                                                               <div class="col-md-12 mx-auto">
                                                                  <input type="text" class="money text-right  form-control ${ product.suppliers == null || product.suppliers.length == 0 ? 'disabled' : '' }" autocomplete="off" value.bind="product.quantity | money" money placeholder="000" disabled.bind="product.suppliers == null || product.suppliers.length == 0" />
                                                               </div>
                                                            </td>
                                                         </tr>
                                                      </tbody>
                                                   </table>
                                                </div>
                                             </div>
                                          </div>
                                       </div> 
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <div class="tab-pane" id="tab2">
                           <div class="card-body">
                              <div class="row" if.bind="isProcessing">
                                 <div class="col-md-6">
                                    <div class="form-group">
                                       <span if.bind="processing" class="badge badge-warning">Efetuando cotação</span>
                                    </div>
                                 </div>
                              </div>
                              <div class="col-md-12">
                                 <div repeat.for="simulation of simulations">
                                    <div class="mt-4">
                                       <h3 if.bind="simulations[$index -1].deliveryDate != simulations[$index].deliveryDate">
                                          <i class="fa batch-icon-layout-center-column mr-2"></i>
                                            Entrega em ${simulation.deliveryDate | dateFormat}  
                                       </h3>
                                       <h4 if.bind="simulations[$index -1].market.name != simulations[$index].market.name" class="ml-4 mt-5">
                                          <i class="batch-icon batch-icon-star mr-2"></i>
                                             ${simulation.market.name}
                                       </h4>
                                       <p class="mt-3" if.bind="! isProcessing && simulation.bestResult.validationMessages != null && simulation.bestResult.validationMessages.length > 0">
                                          <span class="badge badge-danger">
                                          <i class="fa fa-tag mr-2"></i> ${simulation.bestResult.validationMessages}
                                          </span>
                                       </p>
                                    </div>
                                    <div class="mt-4" if.bind="! isProcessing && simulation.bestResult == null">
                                       <p class="mt-3">
                                          <span class="badge badge-danger">
                                          <i class="fa fa-tag mr-2"></i> Nenhum resultado foi retornado
                                          </span>
                                       </p>
                                    </div>
                                    <div class="mt-5 ml-5" if.bind="! isProcessing && (simulation.bestResult.validationMessages == null || simulation.bestResult.validationMessages.length == 0)">
                                      <div  repeat.for="result of simulation.betterResults">
                                       <div class="col-md-12 card-table table-responsive">
                                          <table class="table table-hover table-sm align-middle">
                                             <thead>
                                                <tr>
                                                   <th class="text-left">Fornecedor</th>
                                                   <th class="text-center">Avaliação</th>
                                                   <th class="text-center">Qtde de dias para aceite</th>
                                                   <th class="text-center">Período de Aceite</th>
                                                   <th class="text-center">Dias de entrega</th>
                                                   <th class="text-center">Período de Entrega</th>
                                                   <th class="text-right">Total</th>
                                                </tr>
                                             </thead>
                                             <tbody>
                                                <tr repeat.for="item of result.summaryItems">
                                                   <td>
                                                      ${item.supplier.fantasyName}
                                                   </td>
                                                   <td class="text-center">
                                                      <i aria-hidden="true" class="fa fa-star" style="color: yellow;-webkit-text-stroke-width: 1px;-webkit-text-stroke-color: orange;"></i>
                                                      <i aria-hidden="true" class="fa fa-star" style="color: yellow;-webkit-text-stroke-width: 1px;-webkit-text-stroke-color: orange;"></i>
                                                      <i aria-hidden="true" class="fa fa-star" style="color: yellow;-webkit-text-stroke-width: 1px;-webkit-text-stroke-color: orange;"></i>
                                                      <i aria-hidden="true" class="fa fa-star" style="color: yellow;-webkit-text-stroke-width: 1px;-webkit-text-stroke-color: orange;"></i>
                                                      <i aria-hidden="true" class="fa fa-star" style="color: yellow;-webkit-text-stroke-width: 1px;-webkit-text-stroke-color: orange;"></i>
                                                   </td>
                                                   <td class="text-center">
                                                      ${item.rule.numberOfDaysToAccept} dias
                                                   </td>
                                                   <td class="text-center">
                                                      ${item.rule.periodToAcceptOrder1 | time}
                                                      <label class="mr-sm-2 ml-2" for="inlineFormCustomSelect">as</label>
                                                      ${item.rule.periodToAcceptOrder2 | time}
                                                   </td>
                                                   <td class="text-center">
                                                      <span if.bind="item.rule.deliveryOnMonday" class="badge ${ item.rule.deliveryOnMonday ? 'badge-success' : 'badge-warning' }">Segunda-feira</span>
                                                      <span if.bind="item.rule.deliveryOnTuesday" class="badge  ${ item.rule.deliveryOnTuesday ? 'badge-success' : 'badge-warning' }">Terça-feira</span>
                                                      <span if.bind="item.rule.deliveryOnWednesday" class="badge ${ item.rule.deliveryOnWednesday ? 'badge-success' : 'badge-warning' }">Quarta-feira</span>
                                                      <span if.bind="item.rule.deliveryOnThursday" class="badge  ${ item.rule.deliveryOnThursday ? 'badge-success' : 'badge-warning' }">Quinta-feira</span>
                                                      <span if.bind="item.rule.deliveryOnFriday" class="badge ${ item.rule.deliveryOnFriday ? 'badge-success' : 'badge-warning' }">Sexta-feira</span>
                                                      <br />
                                                      <br />
                                                      <span if.bind="item.rule.deliveryOnSaturday" class="badge ${ item.rule.deliveryOnSaturday ? 'badge-success' : 'badge-warning' }">Sábado</span>
                                                      <span if.bind="item.rule.deliveryOnSunday" class="badge ${ item.rule.deliveryOnSunday ? 'badge-success' : 'badge-warning' }">Domingo</span>
                                                   </td>
                                                   <td class="text-center">
                                                      ${item.rule.deliverySchedule1 | time}
                                                      <label class="mr-sm-2 ml-2" for="inlineFormCustomSelect">as</label>
                                                      ${item.rule.deliverySchedule2 | time}
                                                   </td>
                                                   <td class="text-right">
                                                      ${item.total | money}
                                                   </td>
                                                </tr>
                                             </tbody>
                                          </table>
                                       </div>
                                       <h4 class="mt-5">Produtos</h4>
                                       <div class="col-md-12 card-table table-responsive">
                                          <table class="table table-hover table-sm align-middle">
                                             <thead>
                                                <tr>
                                                   <th class="text-left">Nome do Produto</th>
                                                   <th class="text-left">Descrição</th>
                                                   <th class="text-center">Marca</th>
                                                   <th class="text-center">UM</th>
                                                   <th class="text-right">Preço unitário</th>
                                                   <th class="text-right">Quantidade</th>
                                                   <th class="text-right">Total</th>
                                                </tr>
                                             </thead>
                                             <tbody>
                                                <tr repeat.for="item of result.items">
                                                   <td>
                                                      ${item.product.base.name}
                                                      <div>
                                                         <small class="boldness-light">${item.supplier.fantasyName}</small>
                                                      </div>
                                                   </td>
                                                   <td>
                                                      ${item.product.description}
                                                   </td>
                                                   <td class="text-center">
                                                      ${item.product.brand.name}
                                                   </td>
                                                   <td class="text-center">
                                                      ${item.product.unit.name}
                                                   </td>
                                                   <td class="text-right">
                                                      ${item.price | money}
                                                   </td>
                                                   <td class="text-right">
                                                      ${item.quantity}
                                                   </td>
                                                   <td class="text-right">
                                                      ${item.total | money}
                                                   </td>
                                                </tr>
                                                <tr>
                                                   <td colspan="5" class="text-right">
                                                      <strong>Total:</strong>
                                                   </td>
                                                   <td class="text-right">
                                                      <strong>${result.total  | money}</strong>
                                                   </td>
                                                </tr>
                                             </tbody>
                                          </table>
                                       </div>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <div class="tab-pane" id="tab3">
                           <div class="col-md-12 mt-3" if.bind="isProcessing">
                              <div class="form-group">
                                 <span class="badge badge-warning">Confirme os dados antes de gerar o pedido</span>
                              </div>
                           </div>
                           <div class="col-md-12" repeat.for="simulation of simulations">
                              <div if.bind="(simulation.bestResult.validationMessages == null || simulation.bestResult.validationMessages.length == 0)">
                                 <div class="card-table table-responsive" repeat.for="summary of simulation.bestResult.summaryItems">
                                    <h4> <i class="fa fa-tag mr-2"></i> Pedido ${simulation.market.name} - ${summary.supplier.fantasyName} - ${simulation.deliveryDate | dateFormat}</h4>
                                    <h5 class="mt-5">Informações do fornecedor</h5>
                                    <table class="table table-hover table-sm align-middle mt-1   ">
                                       <thead>
                                          <tr>
                                             <th class="text-left">Fornecedor</th>
                                             <th class="text-center">Avaliação</th>
                                             <th class="text-center">Qtde de dias para aceite</th>
                                             <th class="text-center">Período de Aceite</th>
                                             <th class="text-center">Dias de entrega</th>
                                             <th class="text-center">Período de Entrega</th>
                                             <th class="text-right">Total</th>
                                          </tr>
                                       </thead>
                                       <tbody>
                                          <tr>
                                             <td>
                                                ${summary.supplier.fantasyName}
                                             </td>
                                             <td class="text-center">
                                                <i aria-hidden="true" class="fa fa-star" style="color: yellow;-webkit-text-stroke-width: 1px;-webkit-text-stroke-color: orange;"></i>
                                                <i aria-hidden="true" class="fa fa-star" style="color: yellow;-webkit-text-stroke-width: 1px;-webkit-text-stroke-color: orange;"></i>
                                                <i aria-hidden="true" class="fa fa-star" style="color: yellow;-webkit-text-stroke-width: 1px;-webkit-text-stroke-color: orange;"></i>
                                                <i aria-hidden="true" class="fa fa-star" style="color: yellow;-webkit-text-stroke-width: 1px;-webkit-text-stroke-color: orange;"></i>
                                                <i aria-hidden="true" class="fa fa-star" style="color: yellow;-webkit-text-stroke-width: 1px;-webkit-text-stroke-color: orange;"></i>
                                             </td>
                                             <td class="text-center">
                                                ${summary.rule.numberOfDaysToAccept} dias
                                             </td>
                                             <td class="text-center">
                                                ${summary.rule.periodToAcceptOrder1 | time}
                                                <label class="mr-sm-2 ml-2" for="inlineFormCustomSelect">as</label>
                                                ${summary.rule.periodToAcceptOrder2 | time}
                                             </td>
                                             <td class="text-center">
                                                <span if.bind="summary.rule.deliveryOnMonday" class="badge ${ summary.rule.deliveryOnMonday ? 'badge-success' : 'badge-warning' }">Segunda-feira</span>
                                                <span if.bind="summary.rule.deliveryOnTuesday" class="badge  ${ summary.rule.deliveryOnTuesday ? 'badge-success' : 'badge-warning' }">Terça-feira</span>
                                                <span if.bind="summary.rule.deliveryOnWednesday" class="badge ${ summary.rule.deliveryOnWednesday ? 'badge-success' : 'badge-warning' }">Quarta-feira</span>
                                                <span if.bind="summary.rule.deliveryOnThursday" class="badge  ${ summary.rule.deliveryOnThursday ? 'badge-success' : 'badge-warning' }">Quinta-feira</span>
                                                <span if.bind="summary.rule.deliveryOnFriday" class="badge ${ summary.rule.deliveryOnFriday ? 'badge-success' : 'badge-warning' }">Sexta-feira</span>
                                                <br />
                                                <br />
                                                <span if.bind="summary.rule.deliveryOnSaturday" class="badge ${ summary.rule.deliveryOnSaturday ? 'badge-success' : 'badge-warning' }">Sábado</span>
                                                <span if.bind="summary.rule.deliveryOnSunday" class="badge ${ summary.rule.deliveryOnSunday ? 'badge-success' : 'badge-warning' }">Domingo</span>
                                             </td>
                                             <td class="text-center">
                                                ${summary.rule.deliverySchedule1 | time}
                                                <label class="mr-sm-2 ml-2" for="inlineFormCustomSelect">as</label>
                                                ${summary.rule.deliverySchedule2 | time}
                                             </td>
                                             <td class="text-right">
                                                ${summary.total | money}
                                             </td>
                                          </tr>
                                       </tbody>
                                    </table>
                                    <h5 class="mt-5">Produtos</h5>
                                    <table class="table table-hover mt-1">
                                       <thead>
                                          <tr>
                                             <th class="text-left">Nome do Produto</th>
                                             <th class="text-center">Descrição</th>
                                             <th class="text-center">UM</th>
                                             <th class="text-right">Preço unitário</th>
                                             <th class="text-right">Quantidade</th>
                                             <th class="text-right">Total</th>
                                          </tr>
                                       </thead>
                                       <tbody>
                                          <tr repeat.for="item of summary.items">
                                             <td>
                                                ${item.product.base.name}
                                             </td>
                                             <td class="text-center  align-middle">
                                                ${item.product.description}
                                             </td>
                                             <td class="text-center">
                                                ${item.product.unit.name}
                                             </td>
                                             <td class="text-right">
                                                ${item.price | money}
                                             </td>
                                             <td class="text-right">
                                                ${item.quantity}
                                             </td>
                                             <td class="text-right">
                                                ${item.total | money}
                                             </td>
                                          </tr>
                                          <tr>
                                             <td colspan="5" class="text-right">
                                                <strong>Total:</strong>
                                             </td>
                                             <td class="text-right">
                                                <strong>${summary.total  | money}</strong>
                                             </td>
                                          </tr>
                                       </tbody>
                                    </table>
                                    <p class="mt-5">Deseja acrescentar alguma observação ao pedido?</p>
                                    <div class="form-group mx-auto">
                                       <textarea class="form-control" value.bind="summary.observation" rows="2" keypress.delegate="validateLengthObs(summary)"></textarea>
                                    </div>
                                    <p>${250 - summary.observation.length} caractere(s) restantes</p>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <ul class="pager wizard mt-5">
                           <li class="previous " if.bind="currentStep != 1">
                              <a href="#" class="waves-effect waves-light" click.trigger="back()" if.bind="currentStep > 0 ">Voltar</a>
                           </li>
                           <li class="next" if.bind="isOrderValid && currentStep < totalSteps && ( (currentStep != 2) || (currentStep == 2 && simulations.length > 0) ) ">
                              <a href="#" id="next" class=" ${ ! isOrderValid ? 'disabled' : '' } waves-effect waves-light" click.trigger="advance()">Avançar</a>
                           </li>
                           <li class="finish float-right" if.bind="currentStep == totalSteps">
                              <button type="button" class="btn btn-success waves-effect waves-light" if.bind="! isProcessing && ! orderWasGenerated" click.trigger="generateOrder()">
                              <span class="gradient">Gerar pedido</span>
                              <i class="fa fa-arrow-right" aria-hidden="true"></i>
                              </button>
                              <div class="fa-2x text-center" if.bind="isProcessing">
                                 <i class="fa fa-refresh fa-spin"></i>
                              </div>
                           </li>
                        </ul>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
</template>